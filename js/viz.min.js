var impanelsize=parseInt(d3.select("#snapshot").style("width")),immargin={top:0,right:0,bottom:0,left:0},sppanelw=parseInt(d3.select(".container").style("width"))-impanelsize,sppanelh=0.67*sppanelw,spmargin={top:15,right:5,bottom:20,left:0};if(875>parseInt(d3.select(".container").style("width")))var linewidth=".5px",ccfs="9px",sppanelw=impanelsize,sppanelh=0.3*sppanelw,spmargin={top:15,right:5,bottom:20,left:0};else 700<impanelsize?(linewidth=".75px",ccfs="11px"):(linewidth=".75px",ccfs="12px");
var imsize=impanelsize-immargin.left-immargin.right,spw=sppanelw-spmargin.left-spmargin.right,sph=sppanelh-spmargin.top-spmargin.bottom,sinksize=2,linearRes=256,columndensitypanel=d3.select("#snapshot").append("svg").attr("width",impanelsize).attr("height",impanelsize),proj=columndensitypanel.append("g").attr("width",imsize).attr("height",imsize).attr("transform","translate("+immargin.left+","+immargin.top+")"),projimage=proj.append("image").attr("width",imsize).attr("height",imsize),projimageoverlay=
proj.append("image").attr("width",imsize).attr("height",imsize),projsinkoverlay=proj.append("g").attr("width",imsize).attr("height",imsize),spectrapanel=d3.select("#spectraplot").append("svg").attr("width",sppanelw).attr("height",sppanelh),spectraplot=spectrapanel.append("g").attr("width",spw).attr("height",sph).attr("transform","translate("+spmargin.left+","+spmargin.top+")"),showSurfaceDensityImages=function(){showColumnTotal?(projimage.attr("xlink:href",fImageTotal),d3.select("#totalColumn").attr("class",
"imageselector selected"),d3.select("#moderateColumn").attr("class","imageselector")):showColumnModerate&&(projimage.attr("xlink:href",fImageC18O),d3.select("#totalColumn").attr("class","imageselector"),d3.select("#moderateColumn").attr("class","imageselector selected"))},showHighDensityOverlay=function(){showContourHigh?(projimageoverlay.attr("visibility","visible"),d3.select("#highColumn").attr("class","imageselector selected")):(projimageoverlay.attr("visibility","hidden"),d3.select("#highColumn").attr("class",
"imageselector"))},showSinkParticles=function(){showSinks?(projsinkoverlay.selectAll("circle").attr("visibility","visible"),d3.select("#sinkParticles").attr("class","imageselector selected")):(projsinkoverlay.selectAll("circle").attr("visibility","hidden"),d3.select("#sinkParticles").attr("class","imageselector"))},sinkdata=[{}],initializeSinkParticles=function(){d3.text(fSinks,function(e){null!=e?(sinkdata=d3.csv.parseRows(e).map(function(a){return{id:+a[0],m:+a[1],x:+a[2],y:+a[3],z:+a[4]}}),a(),
showSinkParticles()):proj.selectAll("circle").attr("visibility","hidden")});var a=function(){var a=d3.scale.linear().domain([0,1]).range([0,imsize]),f=d3.scale.linear().domain([0,1]).range([imsize,0]),c=d3.scale.log().domain([0.5,10]).range(["hsl(39, 80%, 60%)","hsl(13, 100%, 50%)"]).interpolate(d3.interpolateHsl),d=projsinkoverlay.selectAll("circle").data(sinkdata);d.attr("cx",function(b){return a(b.x)}).attr("visibility","visible").attr("cy",function(a){return f(a.y)}).attr("fill",function(a){return c(a.m)});
d.enter().append("svg:circle").attr("cx",function(b){return a(b.x)}).attr("cy",function(a){return f(a.y)}).attr("stroke-width","none").attr("fill",function(a){return c(a.m)}).attr("r",sinksize);d.exit().remove()}},specline=d3.svg.line().interpolate("step-before").x(function(a){return velScale(a[0])}).y(function(a){return spScale(a[1])}),setupSpectraPlot=function(){var a=d3.svg.axis().scale(velScale).orient("bottom").ticks(4).tickFormat(function(a){return a+" km/s"});d3.svg.axis().scale(spScale).orient("left");
spectra=d3.zip(d3.extent(velocities),[0,0]);spectraplot.append("path").attr("class","spectraline C18O").attr("d",specline(spectra));spectraplot.append("g").attr("class","x axis").attr("transform","translate(0,"+sph+")").call(a);spectraplot.append("text").attr("x",0.5*spmargin.right).attr("y",1*spmargin.top).attr("class","axislabel C18O").text("C18O spectra (arbitrary units)");spectraplot.append("text").attr("x",0.5*spmargin.right).attr("y",2*spmargin.top).attr("class","axislabel N2Hplus").text("N2H+");
spectraplot.selectAll("line.horizontalGrid").data([512/3,1024/3,511]).enter().append("line").attr("class","horizontalGrid").attr("x1",spmargin.right).attr("x2",spw).attr("y1",function(a){return spScale(a)}).attr("y2",function(a){return spScale(a)})},showSpectra=function(a,e){f=spIndsN2Hplus[linearRes*e+a];b=0;if(0>f)spectra=zeroSpec;else{spN2Hplus=spN2Hplusdata[f].s;for(c=0;c<spN2Hplus.length;c++)if(0>spN2Hplus[c])for(d=0;d<-spN2Hplus[c];d++)specToPlot[b]=0,b+=1;else specToPlot[b]=spN2Hplus[c],b+=
1;spectra=d3.zip(velocities,specToPlot)}d3.select(".spectraline.N2Hplus").remove();spectraplot.append("path").attr("class","spectraline N2Hplus").attr("d",specline(spectra));var f=spIndsC18O[linearRes*e+a],c=0,d=0,b=0;if(0>f)spectra=zeroSpec;else{spC18O=spC18Odata[f].s;for(c=0;c<spC18O.length;c++)if(0>spC18O[c])for(d=0;d<-spC18O[c];d++)specToPlot[b]=0,b+=1;else specToPlot[b]=spC18O[c],b+=1;spectra=d3.zip(velocities,specToPlot)}d3.select(".spectraline.C18O").remove();spectraplot.append("path").attr("class",
"spectraline C18O").attr("d",specline(spectra))},selectTotalColumn=function(){showColumnTotal||(showColumnTotal=!0,showColumnModerate=!1,showSurfaceDensityImages())},selectModerateColumn=function(){showColumnModerate||(showColumnTotal=!1,showColumnModerate=!0,showSurfaceDensityImages())},toggleHighDensity=function(){showContourHigh=!showContourHigh;showHighDensityOverlay()},toggleSinkParticles=function(){showSinks=!showSinks;showSinkParticles()},snap=18,fImageC18O,fImageN2Hplus,fImageTotal,fSinks,
fSpectraC18O,fSpectraN2Hplus,fVelocities,fColumns,showColumnTotal=!1,showColumnModerate=!0,showContourHigh=!0,showSinks=!0,getFileNames=function(a){snapPad=d3.format("05d")(a);fImageTotal="data/images/totalcolumn_2_frame_"+snapPad+".png";fImageC18O="data/images/C18O_2_frame_"+snapPad+".png";fImageN2Hplus="data/images/N2Hplus_2_frame_"+snapPad+".png";fSinks="data/sinks/sink_"+snapPad+".csv";fSpectraC18O="data/spectra/spectra_C18O_"+snapPad+"_sparse.json";fSpectraN2Hplus="data/spectra/spectra_N2Hplus_"+
snapPad+"_sparse.json";fVelocities="data/spectra/velocities.json";fColumns="data/columndensities/columndensities_"+snapPad+".json"},populatePanels=function(a){getFileNames(a);projimageoverlay.attr("xlink:href",fImageN2Hplus);showSurfaceDensityImages();showHighDensityOverlay();initializeSinkParticles()};populatePanels(snap);var sddata;d3.json(fColumns,function(a){sddata=a});
var spC18Odata,spN2Hplusdata,velocities,spIndsC18O=Array.apply(null,Array(linearRes*linearRes)).map(Number.prototype.valueOf,-1),spIndsN2Hplus=Array.apply(null,Array(linearRes*linearRes)).map(Number.prototype.valueOf,-1),spScale=d3.scale.linear().domain([0,512]).range([sph,0]);d3.json(fSpectraC18O,function(a){spC18Odata=a;for(a=0;a<spC18Odata.length;a++)spIndsC18O[spC18Odata[a].c]=a});
d3.json(fSpectraN2Hplus,function(a){spN2Hplusdata=a;for(a=0;a<spN2Hplusdata.length;a++)spIndsN2Hplus[spN2Hplusdata[a].c]=a});var velScale=d3.scale.linear(),specToPlot,vellen,zeroSpec;d3.json(fVelocities,function(a){velocities=a[0].velocity;velScale.domain(d3.extent(velocities)).range([0,spw]);specToPlot=velocities.slice();vellen=velocities.length;a=velocities.slice();for(var e=0;e<vellen;e++)a[e]=0;zeroSpec=d3.zip(velocities,a);setupSpectraPlot()});
var imsizeFrac=(linearRes-1)/linearRes,selectionSize=imsize/linearRes,linearScaleX=d3.scale.linear().domain([0,linearRes-1]).range([0,imsize]).clamp(!0),linearScaleY=d3.scale.linear().domain([0,linearRes-1]).range([imsize,0]).clamp(!0),brush=d3.svg.brush().x(linearScaleX).y(linearScaleY).on("brush",brushed2),spectraSelection=proj.append("svg").attr("width",imsize+immargin.left+immargin.right).attr("height",imsize+immargin.top+immargin.bottom).append("g").attr("transform","translate("+immargin.left+
","+immargin.top+")");spectraSelection.append("g").attr("class","linear axis").select("domain").select(function(){return this.parentNode.appendChild(this.cloneNode(!0))}).attr("class","halo");
var slider=spectraSelection.append("g").attr("class","slider").call(brush),handlepulse=slider.append("circle").attr("class","handlepulse").attr("r",1),handle=slider.append("rect").attr("class","handle").attr("width",selectionSize).attr("height",selectionSize),myrFormat=d3.format(".2f"),snapStep=1,snapPos=function(a){return Math.floor(a/snapStep+0.5)*snapStep},desiredX,desiredY,snappedX,snappedY,currentX,currentY;
function brushed2(){desiredX=brush.extent()[0];desiredY=brush.extent()[1];currentX=snappedX;currentY=snappedY;d3.event.sourceEvent&&(desiredX=linearScaleX.invert(d3.mouse(this)[0]),desiredY=linearScaleY.invert(d3.mouse(this)[1]),snappedX=snapPos(desiredX),snappedY=snapPos(desiredY));if(snappedX!=currentX||snappedY!=currentY)handle.attr("x",linearScaleX(snappedX*imsizeFrac)),handle.attr("y",linearScaleY((snappedY+1)*imsizeFrac)),handlepulse.attr("cx",linearScaleX((snappedX+0.5)*imsizeFrac)),handlepulse.attr("cy",
linearScaleY((snappedY+0.5)*imsizeFrac)),d3.select("#nTotalVal").html(sddata[snappedX].SD[snappedY]),d3.select("#nC18OVal").html(sddata[snappedX].C18O[snappedY]),d3.select("#nN2HplusVal").html(sddata[snappedX].N2Hplus[snappedY]),showSpectra(snappedX,snappedY)}setInterval(function(){handlepulse.attr("r",1).attr("opacity",1).transition().duration(650).attr("r",6*selectionSize).each("end",function(){d3.select(this).transition().duration(300).attr("opacity",0)})},1200);